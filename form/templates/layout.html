{{ define "layout" }}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Form Example</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@5" rel="stylesheet" type="text/css" />
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@5/themes.css" rel="stylesheet" type="text/css" />
    <script type="module">
      if (!("anchorName" in document.documentElement.style)) {
        import("https://unpkg.com/@oddbird/css-anchor-positioning");
      }
    </script>
    <script type="importmap">
    {
        "imports": {
          "datastar": "https://cdn.jsdelivr.net/gh/starfederation/datastar@v1.0.0-beta.11/bundles/datastar-aliased.js",
          "utils/text": "https://cdn.jsdelivr.net/npm/@starfederation/datastar@1.0.0-beta.11/dist/utils/text.js"
        }
    }
    </script>
    <script type="module">
        import { load } from 'datastar'
        import { modifyCasing, trimDollarSignPrefix } from 'utils/text'

        load({
          type: 1,
          name: 'popover',
          keyReq: 3,
          valReq: 3,
          onLoad: ({ el, key, mods, signals, value, effect }) => {
            el.setAttribute('popover', '')

            const signalName = key
              ? modifyCasing(key, mods)
              : trimDollarSignPrefix(value)
            
            const setPopoverFromSignal = () => {
              if(signals.value(signalName)) {
                el.showPopover?.()

                if (mods.has('top')) {
                  el.scrollTo(0, 0)
                }
                
              } else {
                el.hidePopover?.()
              }
            }

            const setSignalFromPopover = (event) => {
                if (event.newState === 'open' && event.oldState !== 'open') {
                  signals.setValue(signalName, true)
                }

                if (event.newState === 'closed' && event.oldState !== 'closed') {
                  signals.setValue(signalName, false)
                }
            }

            el.addEventListener('toggle', setSignalFromPopover)

            const reset = effect(() => setPopoverFromSignal())

            return () => {
              reset()
              el.removeEventListener('toggle', setSignalFromPopover)
            }
          },
        })
    </script>
    <script type="module">
      import { load } from 'datastar';

      load({
        type: 1,
        name: 'key',
        keyReq: 1,
        valReq: 1,
        argNames: ['evt'],
        onLoad: (ctx) => {
          const {el, key, mods, genRX} = ctx
          const rx = genRX()

          let callback = (evt) => {
            if (evt) {
              if (evt.code.toLowerCase() !== key) return
              if (mods.has('prevent') || mods.has('prestop')) evt.preventDefault()
              if (mods.has('stop') || mods.has('prestop')) evt.stopPropagation()
            }
            rx(evt)
          }

          el.addEventListener('keydown', callback)
          return () => {
            el.removeEventListener('keydown', callback)
          }
        }
      });
    </script>
    <style>
        * {
            box-sizing: border-box;
        }
    </style>
  </head>
  <body class="p-4">
    <h1 class="font-bold text-4xl mb-4">User form</h1>
    {{ template "form" . }}
  </body>
</html>
{{ end }}
